# 聊天交互模块

本文档定义了AutoMate项目中聊天交互模块的详细设计。

## 1. 模块概述

### 1.1 模块功能

聊天交互模块负责消息发送与接收、技能调用、文件上传、聊天记录管理等功能。

### 1.2 参考原型

- [MainLayout.html](../../prototypes/MainLayout.html)

## 2. 功能流程

### 2.1 消息发送与接收

**触发场景：** 用户在输入框输入内容并点击发送按钮或按回车键时

**处理流程：**

1. 验证输入内容是否为空
2. 计算消息长度
3. 生成消息ID和时间戳
4. 将消息插入到`chat_messages`表，状态为"pending"
5. 显示消息到聊天窗口，显示发送中状态
6. 尝试发送消息到智能体
7. 发送成功：更新消息状态为"sent"
8. 等待智能体确认：收到确认后更新状态为"delivered"
9. 智能体阅读：智能体处理消息后更新状态为"read"

**错误处理：**

- 输入框为空：自动禁用发送按钮
- 发送失败：更新消息状态为"failed"，显示错误提示和重试按钮
- 网络连接中断：缓存消息并显示离线提示
- 消息过长：显示"消息过长"提示

### 2.2 Skill调用与执行

**触发场景：** 智能体需要调用技能执行任务时

**处理流程：**

1. 解析技能调用请求
2. 验证技能参数的合法性
3. 将技能调用记录插入到`skill_calls`表
4. 执行技能并监控执行状态
5. 更新技能调用记录的状态和执行结果
6. 将执行结果显示到聊天窗口

**错误处理：**

- 技能执行失败：显示错误信息和重试选项
- 技能执行超时：显示超时提示和取消按钮
- 技能参数错误：显示参数错误提示

### 2.3 文件上传与处理

**触发场景：** 用户点击附件按钮并选择文件上传时

**处理流程：**

1. 验证文件类型和大小
2. 生成文件存储路径
3. 上传文件到本地存储
4. 计算文件哈希值
5. 更新`chat_messages`表的附件状态
6. 显示附件预览到聊天窗口

**错误处理：**

- 上传文件为空：显示"请选择文件"提示
- 上传文件失败：显示错误原因和重试按钮
- 上传文件类型不支持：显示"文件类型不支持"提示
- 上传文件过大：显示"文件过大"提示

### 2.4 聊天记录管理

**触发场景：** 用户查看历史聊天记录、导出聊天记录时

**处理流程：**

1. 根据智能体ID和时间范围查询聊天记录
2. 按时间顺序排序显示
3. 支持按关键词搜索聊天记录
4. 支持导出聊天记录为文件

**错误处理：**

- 聊天记录为空：显示"无消息"提示
- 记录加载失败：显示错误提示和重试按钮
- 记录导出失败：显示错误原因和重试按钮

## 3. 视觉设计

### 3.1 页面布局

- **主内容区**：全屏显示，占据右侧所有空间
- **顶部栏**：固定高度64px，包含智能体头像、名称和操作按钮
- **聊天区域**：可滚动区域，消息气泡对齐显示
- **输入区域**：固定底部，包含附件按钮、输入框和发送按钮

### 3.2 配色方案

**浅色主题：**

- 聊天背景：`#f9fafb`
- 用户消息气泡：`#3b82f6`，文本`#ffffff`
- 智能体消息气泡：`#f3f4f6`，文本`#1f2937`
- 时间戳：`#6b7280`
- 输入框背景：`#ffffff`，边框`#e5e7eb`

**深色主题：**

- 聊天背景：`#111827`
- 用户消息气泡：`#60a5fa`，文本`#ffffff`
- 智能体消息气泡：`#374151`，文本`#f9fafb`
- 时间戳：`#9ca3af`
- 输入框背景：`#1f2937`，边框`#4b5563`

### 3.3 按钮样式

- **发送按钮**：图标按钮，圆形，悬停时放大1.1倍
- **附件按钮**：图标按钮，圆形，悬停时颜色变化
- **滚动到底部按钮**：圆形渐变背景按钮，位于右下角

### 3.4 动画效果

- 消息气泡悬停：上浮1px，阴影增强
- 打字指示器：三个点的弹跳动画（1.4秒循环）
- 滚动到底部按钮：平滑显示/隐藏动画
- 消息发送：气泡出现动画

## 4. UI元素

### 4.1 聊天窗口容器

- **样式类**：`chat-content-panel`
- **布局**：垂直flex布局，占据主内容区全部空间
- **滚动条**：自定义样式，6px宽度，圆角

### 4.2 消息气泡

**用户消息气泡：**

- **样式**：蓝色背景（#3b82f6），白色文本，圆角（右上角小圆角）
- **最大宽度**：500px
- **定位**：右对齐

**智能体消息气泡：**

- **样式**：浅灰色背景（#f3f4f6），深色文本，圆角（左下角小圆角）
- **最大宽度**：500px
- **定位**：左对齐

### 4.3 输入区域

**输入框：**

- **id**：`message-input-{agent-id}`
- **placeholder**："输入消息..."
- **样式**：多行文本框，自动调整高度，无边框
- **最小高度**：100px
- **最大高度**：300px

**发送按钮：**

- **id**：`send-btn-{agent-id}`
- **图标**：发送箭头SVG图标
- **尺寸**：28px × 28px
- **禁用状态**：灰色图标，不可点击

## 5. 数据存储

### 5.1 聊天消息存储

- 聊天消息存储在SQLite数据库中
- 数据库表结构详见[数据库设计](../数据层设计/数据库设计.md)

### 5.2 技能调用记录

- 技能调用记录存储在SQLite数据库中
- 数据库表结构详见[数据库设计](../数据层设计/数据库设计.md)

## 6. 数据逻辑

### 6.1 消息发送逻辑

**触发场景：** 用户在输入框输入内容并点击发送按钮或按回车键时

**数据来源：** 用户输入的文本内容、当前选中的智能体信息

**处理流程：**

1. 验证输入内容是否为空
2. 计算消息长度
3. 生成消息ID和时间戳
4. 将消息插入到`chat_messages`表，状态为"pending"
5. 显示消息到聊天窗口，显示发送中状态
6. 尝试发送消息到智能体
7. 发送成功：更新消息状态为"sent"
8. 等待智能体确认：收到确认后更新状态为"delivered"
9. 智能体阅读：智能体处理消息后更新状态为"read"

**数据去向：** `chat_messages`表、聊天窗口的消息展示

**错误处理：**

- 输入框为空：自动禁用发送按钮
- 发送失败：更新消息状态为"failed"，显示错误提示和重试按钮
- 网络连接中断：缓存消息并显示离线提示
- 消息过长：显示"消息过长"提示

### 6.2 技能调用逻辑

**触发场景：** 智能体需要调用技能执行任务时

**数据来源：** 智能体的技能调用请求、`chat_messages`表中的消息记录

**处理流程：**

1. 解析技能调用请求
2. 验证技能参数的合法性
3. 将技能调用记录插入到`skill_calls`表
4. 执行技能并监控执行状态
5. 更新技能调用记录的状态和执行结果
6. 将执行结果显示到聊天窗口

**数据去向：** `skill_calls`表、聊天窗口的结果展示

**错误处理：**

- 技能执行失败：显示错误信息和重试选项
- 技能执行超时：显示超时提示和取消按钮
- 技能参数错误：显示参数错误提示
- 技能不存在：显示"Skill不存在"提示

### 6.3 文件上传逻辑

**触发场景：** 用户点击附件按钮并选择文件上传时

**数据来源：** 用户选择的本地文件、当前选中的智能体信息

**处理流程：**

1. 验证文件类型和大小
2. 生成文件存储路径
3. 上传文件到本地存储
4. 计算文件哈希值
5. 更新`chat_messages`表的附件状态
6. 显示附件预览到聊天窗口

**数据去向：** 本地文件系统、`chat_messages`表、聊天窗口的附件预览

**错误处理：**

- 上传文件为空：显示"请选择文件"提示
- 上传文件失败：显示错误原因和重试按钮
- 上传文件类型不支持：显示"文件类型不支持"提示
- 上传文件过大：显示"文件过大"提示

## 7. 参考资源

- [数据库设计](../数据层设计/数据库设计.md)
- [前端组件接口](../接口层设计/前端组件接口.md)
- [后端API接口](../接口层设计/后端API接口.md)
