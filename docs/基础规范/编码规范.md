# 编码规范

本文档定义了AutoMate项目中React、TypeScript、Node.js的编码规范。所有开发人员必须遵守这些规范，以确保代码质量和可维护性。

## 1. React编码规范

### 1.1 组件定义

**函数组件：**

- 优先使用函数组件和Hooks
- 组件名称使用PascalCase
- 使用箭头函数定义组件
- 示例：
  ```tsx
  import React from 'react';

  interface AgentListProps {
    agents: Agent[];
    onAgentSelect: (agent: Agent) => void;
  }

  const AgentList: React.FC<AgentListProps> = ({ agents, onAgentSelect }) => {
    return (
      <div className="agent-list">
        {agents.map(agent => (
          <AgentItem
            key={agent.id}
            agent={agent}
            onSelect={onAgentSelect}
          />
        ))}
      </div>
    );
  };

  export default AgentList;
  ```

### 1.2 Hooks使用规范

**自定义Hook：**

- 以`use`开头
- 只在函数组件或自定义Hook中调用
- 在组件顶层调用，不要在循环、条件或嵌套函数中调用
- 示例：
  ```tsx
  function useAgentList() {
    const [agents, setAgents] = useState<Agent[]>([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
      loadAgents();
    }, []);

    const loadAgents = async () => {
      setLoading(true);
      try {
        const data = await fetchAgents();
        setAgents(data);
      } catch (error) {
        console.error('Failed to load agents:', error);
      } finally {
        setLoading(false);
      }
    };

    return { agents, loading, loadAgents };
  }
  ```

**常用Hooks：**

- `useState`: 管理组件状态
- `useEffect`: 处理副作用
- `useContext`: 访问Context
- `useCallback`: 缓存回调函数
- `useMemo`: 缓存计算结果
- `useRef`: 访问DOM元素或存储可变值

### 1.3 Props定义

**接口定义：**

- 使用TypeScript接口定义Props
- Props名称使用camelCase
- 回调函数以`on`开头
- 示例：
  ```tsx
  interface MessageBubbleProps {
    message: Message;
    isOwn: boolean;
    onCopy: (content: string) => void;
    onDelete: (messageId: string) => void;
  }

  const MessageBubble: React.FC<MessageBubbleProps> = ({
    message,
    isOwn,
    onCopy,
    onDelete
  }) => {
    // 组件实现
  };
  ```

**默认Props：**

- 使用解构赋值设置默认值
- 示例：
  ```tsx
  interface ButtonProps {
    text: string;
    disabled?: boolean;
    onClick?: () => void;
  }

  const Button: React.FC<ButtonProps> = ({
    text,
    disabled = false,
    onClick
  }) => {
    // 组件实现
  };
  ```

### 1.4 状态管理

**useState使用：**

- 使用解构赋值获取状态和更新函数
- 更新函数命名以`set`开头
- 示例：
  ```tsx
  const [messages, setMessages] = useState<Message[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  ```

**状态更新：**

- 使用函数式更新避免闭包问题
- 示例：
  ```tsx
  // 错误示例
  const addMessage = (message: Message) => {
    setMessages([...messages, message]);
  };

  // 正确示例
  const addMessage = (message: Message) => {
    setMessages(prevMessages => [...prevMessages, message]);
  };
  ```

### 1.5 事件处理

**事件处理函数：**

- 以`handle`开头
- 使用`useCallback`缓存回调函数
- 示例：
  ```tsx
  const handleSendMessage = useCallback(async () => {
    if (!inputValue.trim()) return;

    try {
      await sendMessage(inputValue);
      setInputValue('');
    } catch (error) {
      setError('Failed to send message');
    }
  }, [inputValue, sendMessage]);

  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setInputValue(e.target.value);
  }, []);
  ```

**事件类型：**

- 使用React事件类型
- 示例：
  ```tsx
  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.preventDefault();
    // 处理点击事件
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    // 处理输入变化
  };
  ```

### 1.6 条件渲染

**三元运算符：**

- 用于简单的条件渲染
- 示例：
  ```tsx
  {isLoading ? <Spinner /> : <Content />}
  ```

**逻辑与运算符：**

- 用于可选的条件渲染
- 示例：
  ```tsx
  {error && <ErrorMessage message={error} />}
  ```

**条件组件：**

- 用于复杂的条件渲染
- 示例：
  ```tsx
  const renderMessage = () => {
    if (message.type === 'text') {
      return <TextMessage message={message} />;
    } else if (message.type === 'image') {
      return <ImageMessage message={message} />;
    } else if (message.type === 'file') {
      return <FileMessage message={message} />;
    }
    return null;
  };
  ```

### 1.7 列表渲染

**使用map渲染列表：**

- 必须提供唯一的key
- key应该是稳定的、唯一的标识符
- 示例：
  ```tsx
  {agents.map(agent => (
    <AgentItem
      key={agent.id}
      agent={agent}
      onSelect={handleAgentSelect}
    />
  ))}
  ```

**避免使用索引作为key：**

- 除非列表是静态的
- 示例：
  ```tsx
  // 不推荐
  {items.map((item, index) => (
    <Item key={index} item={item} />
  ))}

  // 推荐
  {items.map(item => (
    <Item key={item.id} item={item} />
  ))}
  ```

### 1.8 样式处理

**使用Tailwind CSS：**

- 优先使用Tailwind CSS类名
- 示例：
  ```tsx
  <div className="flex items-center justify-between p-4 bg-white rounded-lg shadow">
    <span className="text-lg font-semibold text-gray-900">
      {agent.name}
    </span>
  </div>
  ```

**动态类名：**

- 使用模板字符串或classnames库
- 示例：
  ```tsx
  <div className={`agent-item ${isSelected ? 'selected' : ''}`}>
    {agent.name}
  </div>
  ```

**内联样式：**

- 仅用于动态样式
- 示例：
  ```tsx
  <div style={{ width: `${progress}%` }}>
    {progress}%
  </div>
  ```

### 1.9 性能优化

**React.memo：**

- 避免不必要的重新渲染
- 示例：
  ```tsx
  const AgentItem = React.memo<AgentItemProps>(({ agent, onSelect }) => {
    return (
      <div onClick={() => onSelect(agent)}>
        {agent.name}
      </div>
    );
  });
  ```

**useCallback：**

- 缓存回调函数
- 示例：
  ```tsx
  const handleClick = useCallback(() => {
    // 处理点击
  }, [dependency]);
  ```

**useMemo：**

- 缓存计算结果
- 示例：
  ```tsx
  const filteredAgents = useMemo(() => {
    return agents.filter(agent =>
      agent.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [agents, searchTerm]);
  ```

## 2. TypeScript编码规范

### 2.1 类型定义

**接口定义：**

- 使用`interface`定义对象类型
- 使用`type`定义联合类型、交叉类型等
- 示例：
  ```typescript
  interface Agent {
    id: string;
    name: string;
    description: string;
    avatar: string;
    type: AgentType;
  }

  type AgentType = 'chat' | 'code' | 'data';
  ```

**泛型使用：**

- 使用泛型提高代码复用性
- 示例：
  ```typescript
  function identity<T>(arg: T): T {
    return arg;
  }

  interface ApiResponse<T> {
    data: T;
    message: string;
  }
  ```

**类型守卫：**

- 使用类型守卫缩小类型范围
- 示例：
  ```typescript
  function isString(value: unknown): value is string {
    return typeof value === 'string';
  }

  function processValue(value: unknown) {
    if (isString(value)) {
      console.log(value.toUpperCase());
    }
  }
  ```

### 2.2 类型注解

**函数参数和返回值：**

- 为所有函数参数和返回值添加类型注解
- 示例：
  ```typescript
  function sendMessage(content: string, agentId: string): Promise<Message> {
    // 函数实现
  }
  ```

**变量声明：**

- 为变量添加类型注解（当类型不明显时）
- 示例：
  ```typescript
  const agents: Agent[] = [];
  const messageCount: number = 0;
  const isLoading: boolean = false;
  ```

### 2.3 严格模式

**启用严格模式：**

- 在`tsconfig.json`中启用严格模式
- 示例：
  ```json
  {
    "compilerOptions": {
      "strict": true,
      "noImplicitAny": true,
      "strictNullChecks": true
    }
  }
  ```

**处理null和undefined：**

- 使用可选链操作符`?.`
- 使用空值合并操作符`??`
- 示例：
  ```typescript
  const agentName = agent?.name ?? 'Unknown';
  const messageContent = message?.content ?? '';
  ```

### 2.4 类型导出和导入

**导出类型：**

- 使用`export`关键字导出类型
- 示例：
  ```typescript
  export interface Agent {
    id: string;
    name: string;
  }

  export type AgentType = 'chat' | 'code' | 'data';
  ```

**导入类型：**

- 使用`import type`导入类型
- 示例：
  ```typescript
  import type { Agent, AgentType } from './types';
  ```

## 3. Node.js编码规范

### 3.1 代码风格

**遵循ESLint规则：**

- 使用2个空格缩进
- 每行最大长度100个字符
- 使用空行分隔函数和模块
- 示例：
  ```javascript
  /**
   * Send a message to an agent.
   * @param {string} content - The message content.
   * @param {string} agentId - The agent ID.
   * @returns {Promise<Object>} The sent message.
   */
  async function sendMessage(content, agentId) {
    // 函数实现
    return message;
  }
  ```

### 3.2 类型注解

**使用JSDoc类型注解：**

- 为所有函数参数和返回值添加类型注解
- 示例：
  ```javascript
  /**
   * Load all agents from the database.
   * @returns {Promise<Array<Object>>} A list of agents.
   */
  async function loadAgents() {
    // 函数实现
    return agents;
  }

  /**
   * Send a message to an agent.
   * @param {string} content - The message content.
   * @param {string} agentId - The agent ID.
   * @returns {Promise<Object>} The sent message.
   */
  async function sendMessage(content, agentId) {
    // 函数实现
    return message;
  }
  ```

**变量命名：**

- 使用camelCase命名变量和函数
- 使用PascalCase命名类
- 示例：
  ```javascript
  const agents = [];
  const messageCount = 0;
  const isLoading = false;
  ```

### 3.3 异步编程

**使用async/await：**

- 使用async/await进行异步编程
- 示例：
  ```javascript
  /**
   * Send a message to an agent asynchronously.
   * @param {string} content - The message content.
   * @param {string} agentId - The agent ID.
   * @returns {Promise<Object>} The sent message.
   */
  async function sendMessage(content, agentId) {
    // 异步操作
    await new Promise(resolve => setTimeout(resolve, 1000));
    // 返回消息
    return { content, agentId };
  }
  ```

### 3.4 错误处理

**使用try-catch：**

- 捕获并处理异常
- 示例：
  ```javascript
  try {
    const message = await sendMessage(content, agentId);
    return message;
  } catch (error) {
    console.error('Error sending message:', error);
    throw error;
  }
  ```

**自定义错误：**

- 定义自定义错误类
- 示例：
  ```javascript
  class AgentNotFoundError extends Error {
    /**
     * Create an AgentNotFoundError.
     * @param {string} agentId - The agent ID.
     */
    constructor(agentId) {
      super(`Agent ${agentId} not found`);
      this.name = 'AgentNotFoundError';
      this.agentId = agentId;
    }
  }
  ```

### 3.5 日志记录

**使用console或winston：**

- 使用console或winston记录日志
- 示例：
  ```javascript
  /**
   * Send a message to an agent.
   * @param {string} content - The message content.
   * @param {string} agentId - The agent ID.
   * @returns {Promise<Object>} The sent message.
   */
  async function sendMessage(content, agentId) {
    console.log(`Sending message to agent ${agentId}`);
    try {
      // 发送消息
      console.debug(`Message sent successfully: ${content}`);
      return message;
    } catch (error) {
      console.error(`Failed to send message: ${error}`);
      throw error;
    }
  }
  ```

**日志级别：**

- debug: 详细的调试信息
- log: 一般信息
- warn: 警告信息
- error: 错误信息

### 3.6 数据验证

**使用自定义验证函数：**

- 使用自定义函数进行数据验证
- 示例：
  ```javascript
  /**
   * Validate message data.
   * @param {Object} message - The message data.
   * @returns {Object} The validated message.
   * @throws {Error} If validation fails.
   */
  function validateMessage(message) {
    if (!message.content || !message.content.trim()) {
      throw new Error('Content must not be empty');
    }
    if (!message.agentId) {
      throw new Error('Agent ID is required');
    }
    return {
      content: message.content,
      agentId: message.agentId,
      messageType: message.messageType || 'user'
    };
  }
  ```

## 4. 通用编码规范

### 4.1 代码注释

**函数文档字符串：**

- 为所有函数添加JSDoc注释
- 使用JSDoc风格
- 示例：
  ```javascript
  /**
   * Send a message to an agent.
   * @param {string} content - The message content.
   * @param {string} agentId - The agent ID.
   * @returns {Promise<Object>} The sent message.
   * @throws {Error} If the network connection fails.
   * @throws {Error} If the database operation fails.
   */
  async function sendMessage(content, agentId) {
    // 函数实现
    return message;
  }
  ```

**行内注释：**

- 解释复杂的逻辑
- 不要注释显而易见的代码
- 示例：
  ```javascript
  // 计算消息的哈希值，用于去重
  const crypto = require('crypto');
  const messageHash = crypto.createHash('sha256').update(content).digest('hex');

  // 将消息保存到数据库
  await saveMessage(message);
  ```

### 4.2 代码格式化

**使用Prettier（前端）：**

- 自动格式化代码
- 配置`.prettierrc`文件

**使用Prettier（Node.js）：**

- 自动格式化JavaScript代码
- 配置`.prettierrc`文件

### 4.3 代码检查

**使用ESLint（前端）：**

- 检查代码质量
- 配置`.eslintrc.js`文件

**使用ESLint（Node.js）：**

- 检查JavaScript代码质量
- 配置`.eslintrc.js`文件

### 4.4 版本控制

**Git提交信息：**

- 遵循[命名规范](./命名规范.md)中的Git提交信息规范
- 使用语义化提交信息

**分支命名：**

- `feature/`: 新功能
- `bugfix/`: 修复bug
- `hotfix/`: 紧急修复
- `refactor/`: 重构
- 示例：`feature/agent-search`, `bugfix/message-send-error`

## 5. 代码审查清单

在提交代码前，请检查以下项目：

- [ ] 代码符合命名规范
- [ ] 代码符合编码规范
- [ ] 函数和类有完整的JSDoc注释
- [ ] 类型注解完整且正确
- [ ] 错误处理完善
- [ ] 日志记录适当
- [ ] 代码格式化正确
- [ ] 代码检查通过（ESLint）
- [ ] 单元测试覆盖充分
- [ ] 性能考虑合理

## 6. 参考资源

- [React官方文档](https://react.dev/)
- [TypeScript官方文档](https://www.typescriptlang.org/docs/)
- [Node.js官方文档](https://nodejs.org/docs/latest-v18.x/api/)
- [Express.js官方文档](https://expressjs.com/)
- [Tailwind CSS文档](https://tailwindcss.com/docs)
- [ESLint文档](https://eslint.org/docs/latest/)
- [开发环境配置规范](./开发环境配置.md)

## 7. 参考资源
