# 安全设计

本文档定义了AutoMate项目的安全设计，包括数据加密、权限控制、防注入等。

## 1. 安全目标

### 1.1 安全原则

- **最小权限原则**：仅授予必要的最小权限
- **纵深防御**：多层安全防护
- **安全默认**：默认配置为安全状态
- **透明性**：安全策略清晰可见

### 1.2 安全目标

| 目标 | 说明 |
| :--- | :--- |
| 数据加密 | 聊天数据本地加密存储 |
| 权限控制 | 智能体配置文件权限控制 |
| 沙箱隔离 | 技能执行沙箱隔离 |
| 敏感信息保护 | 敏感信息加密存储 |
| 防注入 | 防止SQL注入和XSS攻击 |

## 2. 数据加密

### 2.1 加密算法

**聊天数据加密：**

- 算法：AES-256
- 模式：GCM（Galois/Counter Mode）
- 密钥长度：256位
- IV长度：96位

**敏感信息加密：**

- 算法：AES-256
- 模式：CBC（Cipher Block Chaining）
- 密钥长度：256位
- IV长度：128位

### 2.2 密钥管理

**密钥生成：**

```python
from cryptography.fernet import Fernet

def generate_key() -> bytes:
    """Generate encryption key."""
    return Fernet.generate_key()
```

**密钥存储：**

- 密钥文件路径：`./config/encryption.key`
- 文件权限：0o600（仅所有者可读写）
- 加密存储密钥（可选）

**密钥轮换：**

- 定期轮换密钥（建议每6个月）
- 密钥轮换时重新加密所有数据
- 保留旧密钥一段时间用于解密旧数据

### 2.3 数据加密实现

**加密聊天消息：**

```python
from cryptography.fernet import Fernet

def encrypt_message(content: str, key: bytes) -> bytes:
    """Encrypt message content."""
    fernet = Fernet(key)
    encrypted_content = fernet.encrypt(content.encode())
    return encrypted_content
```

**解密聊天消息：**

```python
def decrypt_message(encrypted_content: bytes, key: bytes) -> str:
    """Decrypt message content."""
    fernet = Fernet(key)
    decrypted_content = fernet.decrypt(encrypted_content)
    return decrypted_content.decode()
```

## 3. 权限控制

### 3.1 文件权限控制

**配置文件权限：**

```python
import os

def set_config_permissions(config_path: str):
    """Set configuration file permissions."""
    os.chmod(config_path, 0o600)
```

**数据库文件权限：**

```python
def set_database_permissions(db_path: str):
    """Set database file permissions."""
    os.chmod(db_path, 0o600)
```

### 3.2 API权限控制

**身份验证：**

```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def verify_token(credentials: HTTPAuthorizationCredentials = Depends(security)):
    """Verify authentication token."""
    token = credentials.credentials

    if not token:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials"
        )

    # 验证token
    if not validate_token(token):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials"
        )

    return token
```

**权限验证：**

```python
from fastapi import Depends

async def check_permission(permission: str, token: str = Depends(verify_token)):
    """Check user permission."""
    user_permissions = get_user_permissions(token)

    if permission not in user_permissions:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Permission denied"
        )

    return True
```

### 3.3 技能权限控制

**技能白名单：**

```python
SKILL_WHITELIST = [
    'search',
    'file_process',
    'data_analysis'
]

def validate_skill(skill_name: str) -> bool:
    """Validate skill name."""
    return skill_name in SKILL_WHITELIST
```

**技能参数验证：**

```python
from pydantic import BaseModel, validator

class SkillParams(BaseModel):
    """Skill parameters model."""

    skill_name: str
    parameters: dict

    @validator('skill_name')
    def skill_name_must_be_valid(cls, v):
        if not validate_skill(v):
            raise ValueError('Invalid skill name')
        return v
```

## 4. 防注入

### 4.1 SQL注入防护

**使用参数化查询：**

```python
# 错误示例（SQL注入风险）
query = f"SELECT * FROM agents WHERE id = '{agent_id}'"

# 正确示例（参数化查询）
query = "SELECT * FROM agents WHERE id = ?"
cursor.execute(query, (agent_id,))
```

**使用ORM：**

```python
from sqlalchemy import text

# 使用SQLAlchemy ORM
agents = session.query(Agent).filter(Agent.id == agent_id).all()
```

### 4.2 XSS防护

**输入验证：**

```python
import re

def validate_input(input_str: str) -> str:
    """Validate and sanitize input."""
    # 移除危险字符
    sanitized = re.sub(r'[<>\"\'&]', '', input_str)
    return sanitized
```

**输出编码：**

```typescript
// 前端输出编码
function escapeHtml(unsafe: string): string {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
```

**使用DOM API：**

```typescript
// 使用textContent而不是innerHTML
element.textContent = userInput;

// 而不是
element.innerHTML = userInput; // XSS风险
```

### 4.3 命令注入防护

**避免直接执行用户输入：**

```python
import subprocess

# 错误示例（命令注入风险）
command = f"ls {user_input}"
subprocess.run(command, shell=True)

# 正确示例（使用参数列表）
subprocess.run(['ls', user_input])
```

## 5. 沙箱隔离

### 5.1 技能执行沙箱

**使用进程隔离：**

```python
import subprocess

def execute_skill(skill_name: str, parameters: dict) -> dict:
    """Execute skill in isolated process."""
    try:
        result = subprocess.run(
            ['python', '-m', skill_name],
            input=json.dumps(parameters),
            capture_output=True,
            timeout=30,
            check=True
        )
        return json.loads(result.stdout)
    except subprocess.TimeoutExpired:
        raise TimeoutError('Skill execution timeout')
    except subprocess.CalledProcessError as e:
        raise RuntimeError(f'Skill execution failed: {e.stderr}')
```

**使用虚拟环境：**

```python
import venv

def create_skill_venv(skill_path: str):
    """Create virtual environment for skill."""
    venv.create(skill_path / 'venv', with_pip=True)
```

### 5.2 文件访问隔离

**限制文件访问路径：**

```python
import os

def validate_file_path(file_path: str, allowed_dir: str) -> bool:
    """Validate file path is within allowed directory."""
    abs_path = os.path.abspath(file_path)
    abs_allowed_dir = os.path.abspath(allowed_dir)

    return abs_path.startswith(abs_allowed_dir)
```

**使用安全文件操作：**

```python
import tempfile

def create_temp_file(suffix: str) -> str:
    """Create temporary file in secure directory."""
    fd, path = tempfile.mkstemp(suffix=suffix)
    os.close(fd)
    return path
```

## 6. 传输安全

### 6.1 HTTPS/TLS

**启用HTTPS：**

```python
from fastapi import FastAPI
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware

app = FastAPI()

# 强制HTTPS
app.add_middleware(HTTPSRedirectMiddleware)
```

**TLS配置：**

```python
import ssl

ssl_context = ssl.create_default_context(purpose=ssl.Purpose.CLIENT_AUTH)
ssl_context.check_hostname = False
ssl_context.verify_mode = ssl.CERT_NONE
```

### 6.2 数据传输加密

**使用加密传输：**

```python
from cryptography.fernet import Fernet

def encrypt_for_transmission(data: str, key: bytes) -> bytes:
    """Encrypt data for transmission."""
    fernet = Fernet(key)
    return fernet.encrypt(data.encode())
```

## 7. 日志和审计

### 7.1 安全日志

**记录安全事件：**

```python
import logging

logger = logging.getLogger('security')

def log_security_event(event_type: str, details: dict):
    """Log security event."""
    logger.warning(f'Security event: {event_type}', extra=details)
```

**日志内容：**

- 登录/登出事件
- 权限变更事件
- 数据访问事件
- 异常访问事件

### 7.2 审计日志

**记录审计信息：**

```python
def log_audit(action: str, user: str, resource: str, result: str):
    """Log audit information."""
    audit_log = {
        'timestamp': datetime.now().isoformat(),
        'action': action,
        'user': user,
        'resource': resource,
        'result': result
    }
    save_audit_log(audit_log)
```

## 8. 安全检查清单

在开发过程中，请检查以下项目：

- [ ] 所有敏感数据使用AES-256加密
- [ ] 密钥文件权限设置为0o600
- [ ] 使用参数化查询防止SQL注入
- [ ] 所有用户输入进行验证和清理
- [ ] 使用textContent而不是innerHTML
- [ ] 技能执行使用进程隔离
- [ ] 文件访问路径进行验证
- [ ] 启用HTTPS/TLS
- [ ] 记录所有安全事件
- [ ] 定期进行安全审计

## 9. 参考资源

- [OWASP安全指南](https://owasp.org/www-project-top-ten/)
- [Python安全最佳实践](https://wiki.python.org/moin/Security)
- [FastAPI安全文档](https://fastapi.tiangolo.com/tutorial/security/)
- [React安全文档](https://react.dev/learn/render-and-commit#referencing-values-with-refs)
