# 可维护性设计

本文档定义了AutoMate项目的可维护性设计，包括模块化、日志等。

## 1. 可维护性目标

### 1.1 可维护性原则

- **模块化**：按功能模块划分代码
- **可读性**：代码清晰易懂
- **可测试性**：代码易于测试
- **可扩展性**：代码易于扩展
- **文档化**：完善的代码注释和文档

### 1.2 可维护性目标

| 目标 | 说明 |
| :--- | :--- |
| 模块化架构设计 | 按功能模块划分代码 |
| 完善的日志记录机制 | 便于问题定位和系统维护 |
| 代码注释覆盖率 > 80% | 代码注释充分 |
| 单元测试覆盖率 > 70% | 单元测试充分 |
| 版本控制使用Git | 使用Git进行版本控制 |
| 遵循语义化版本规范 | 版本号遵循语义化规范 |

## 2. 模块化设计

### 2.1 模块划分原则

- **高内聚**：模块内部功能相关
- **低耦合**：模块间依赖最小化
- **单一职责**：每个模块只负责一个功能
- **接口清晰**：模块间接口定义清晰

### 2.2 前端模块划分

**目录结构：**

```
src/
├── components/          # 通用组件
├── modules/            # 功能模块
│   ├── agent/         # 智能体模块
│   ├── chat/          # 聊天模块
│   ├── theme/         # 主题模块
│   └── startup/       # 启动页模块
├── hooks/              # 自定义Hooks
├── services/           # 服务层
├── utils/              # 工具函数
├── types/              # 类型定义
└── constants/          # 常量定义
```

**模块示例：**

```typescript
// modules/agent/AgentList.tsx
import React from 'react';
import { useAgentList } from '../../hooks/useAgentList';
import AgentItem from './AgentItem';

const AgentList: React.FC = () => {
  const { agents, loading } = useAgentList();

  if (loading) return <LoadingSpinner />;

  return (
    <div className="agent-list">
      {agents.map(agent => (
        <AgentItem key={agent.id} agent={agent} />
      ))}
    </div>
  );
};

export default AgentList;
```

### 2.3 后端模块划分

**目录结构：**

```
backend/
├── api/                # API路由
├── services/            # 业务逻辑
├── models/              # 数据模型
├── schemas/             # 数据验证
├── utils/               # 工具函数
└── config/              # 配置文件
```

**模块示例：**

```python
# services/agent_service.py
from typing import List, Dict
from models.agent import Agent
from utils.logger import get_logger

logger = get_logger(__name__)

class AgentService:
    """Agent service."""

    def get_agents(self) -> List[Agent]:
        """Get all agents."""
        logger.info('Fetching all agents')
        agents = Agent.query.all()
        return agents

    def get_agent(self, agent_id: str) -> Agent:
        """Get agent by ID."""
        logger.info(f'Fetching agent {agent_id}')
        agent = Agent.query.filter_by(id=agent_id).first()
        return agent
```

## 3. 代码规范

### 3.1 命名规范

遵循[命名规范](../基础规范/命名规范.md)中定义的命名规范。

### 3.2 代码注释

**函数注释：**

```python
def send_message(content: str, agent_id: str) -> dict:
    """Send a message to an agent.

    Args:
        content: The message content.
        agent_id: The agent ID.

    Returns:
        A dictionary containing the sent message information.

    Raises:
        ValueError: If the content is empty.
        NetworkError: If the network connection fails.
    """
    # 函数实现
    pass
```

**类注释：**

```python
class AgentService:
    """Agent service for managing agent-related operations.

    This service provides methods for:
    - Fetching agents
    - Updating agent status
    - Managing agent configuration
    """
```

**行内注释：**

```python
# 计算消息的哈希值，用于去重
message_hash = hashlib.sha256(content.encode()).hexdigest()

# 将消息保存到数据库
await save_message(message)
```

### 3.3 代码格式化

**使用格式化工具：**

- 前端：Prettier
- 后端：Black

**配置文件：**

```json
// .prettierrc
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5"
}
```

```toml
# pyproject.toml
[tool.black]
line-length = 88
target-version = ['py38']
```

## 4. 日志记录

### 4.1 日志级别

| 级别 | 说明 | 使用场景 |
| :--- | :--- | :--- |
| DEBUG | 详细的调试信息 | 开发调试 |
| INFO | 一般信息 | 正常操作记录 |
| WARNING | 警告信息 | 潜在问题 |
| ERROR | 错误信息 | 错误发生 |
| CRITICAL | 严重错误 | 系统崩溃 |

### 4.2 日志格式

**日志格式：**

```python
import logging
from datetime import datetime

# 配置日志格式
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
```

**日志示例：**

```
2024-01-01 12:00:00 - agent_service - INFO - Fetching all agents
2024-01-01 12:00:01 - agent_service - ERROR - Failed to fetch agents: Connection timeout
```

### 4.3 日志记录

**前端日志：**

```typescript
import { invoke } from '@tauri-apps/api/tauri';

// 调用后端函数
console.log('Calling get_agents');
const agents = await invoke('get_agents');
console.log('Received agents:', agents);

// 错误日志
try {
  const result = await invoke('function_name', params);
} catch (error) {
  console.error('Error invoking function:', error);
}
```

**后端日志：**

```python
import logging

logger = logging.getLogger(__name__)

def get_agents() -> list[dict]:
    """Get all agents."""
    logger.info('Fetching all agents')

    try:
        agents = load_agents_from_config()
        logger.info(f'Fetched {len(agents)} agents')
        return agents
    except Exception as e:
        logger.error(f'Failed to fetch agents: {e}')
        raise
```

### 4.4 日志文件

**日志文件配置：**

```python
import logging
from logging.handlers import RotatingFileHandler

# 配置日志文件
log_handler = RotatingFileHandler(
    'logs/app.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5
)

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[log_handler]
)
```

## 5. 测试

### 5.1 单元测试

**前端单元测试：**

```typescript
// AgentList.test.tsx
import { render, screen } from '@testing-library/react';
import AgentList from './AgentList';

describe('AgentList', () => {
  it('should render agents', () => {
    const agents = [
      { id: 'agent1', name: 'Agent 1' },
      { id: 'agent2', name: 'Agent 2' }
    ];

    render(<AgentList agents={agents} />);

    expect(screen.getByText('Agent 1')).toBeInTheDocument();
    expect(screen.getByText('Agent 2')).toBeInTheDocument();
  });
});
```

**后端单元测试：**

```python
# test_agent_service.py
import pytest
from services.agent_service import AgentService

def test_get_agents():
    """Test getting all agents."""
    service = AgentService()
    agents = service.get_agents()

    assert len(agents) > 0
    assert all('id' in agent for agent in agents)
```

### 5.2 集成测试

**前端集成测试：**

```typescript
// AgentList.integration.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import AgentList from './AgentList';

describe('AgentList Integration', () => {
  it('should handle agent selection', async () => {
    const onAgentSelect = jest.fn();
    const agents = [{ id: 'agent1', name: 'Agent 1' }];

    render(<AgentList agents={agents} onAgentSelect={onAgentSelect} />);

    fireEvent.click(screen.getByText('Agent 1'));

    expect(onAgentSelect).toHaveBeenCalledWith(agents[0]);
  });
});
```

**后端集成测试：**

```python
# test_api.py
import pytest
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_get_agents_api():
    """Test getting agents API."""
    response = client.get('/api/agents')

    assert response.status_code == 200
    data = response.json()
    assert 'agents' in data['data']
```

## 6. 版本控制

### 6.1 Git工作流

**分支策略：**

- `main`：主分支，稳定版本
- `develop`：开发分支
- `feature/*`：功能分支
- `bugfix/*`：修复分支
- `hotfix/*`：紧急修复分支

**分支命名：**

```
feature/agent-search
feature/chat-improvements
bugfix/message-send-error
hotfix/critical-security-fix
```

### 6.2 提交规范

遵循[命名规范](../基础规范/命名规范.md)中定义的Git提交信息规范。

**提交示例：**

```
feat(agent): add agent search functionality

- Add search input component
- Implement search logic
- Add search result highlighting

Closes #123
```

### 6.3 版本号规范

遵循语义化版本规范（Semantic Versioning）。

**版本号格式：** MAJOR.MINOR.PATCH

- MAJOR：不兼容的API修改
- MINOR：向下兼容的功能性新增
- PATCH：向下兼容的问题修正

**版本示例：**

```
1.0.0 - 初始版本
1.1.0 - 新增功能
1.1.1 - 修复bug
2.0.0 - 不兼容的API修改
```

## 7. 文档管理

### 7.1 代码文档

**API文档：**

- 使用Swagger/OpenAPI自动生成API文档
- 提供API使用示例
- 说明请求和响应格式

**组件文档：**

- 为每个组件添加JSDoc注释
- 说明组件用途和Props
- 提供使用示例

### 7.2 项目文档

**文档目录：**

```
docs/
├── 基础规范/
├── 数据层设计/
├── 接口层设计/
├── 业务功能模块/
├── 非功能设计/
└── 技术架构/
```

**文档维护：**

- 随项目迭代同步更新
- 重大更新前需经过团队审核
- 与项目版本保持同步

## 8. 可维护性检查清单

在开发过程中，请检查以下项目：

- [ ] 代码按功能模块划分
- [ ] 模块间依赖最小化
- [ ] 代码注释覆盖率 > 80%
- [ ] 函数和类有完整的文档字符串
- [ ] 遵循命名规范
- [ ] 代码格式化正确
- [ ] 日志记录适当
- [ ] 单元测试覆盖率 > 70%
- [ ] 使用Git进行版本控制
- [ ] 遵循语义化版本规范

## 9. 参考资源

- [Python代码风格指南](https://peps.python.org/pep-0008/)
- [React最佳实践](https://react.dev/learn/thinking-in-react)
- [Git工作流指南](https://www.atlassian.com/git/tutorials/comparing-workflows/)
