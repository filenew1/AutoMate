# 数据库技术

本文档定义了AutoMate项目的数据库技术。

## 1. 数据库概述

### 1.1 数据库类型

- **数据库类型**：SQLite 3.40.0+
- **数据库文件路径**：`./data/automate.db`
- **数据库驱动**：sqlite3 或 better-sqlite3（Node.js兼容的SQLite库）

### 1.2 数据库特性

- 轻量级嵌入式数据库，无需额外安装
- 支持事务处理
- 支持外键约束
- 支持索引优化
- 支持数据加密

## 2. SQLite

### 2.1 SQLite特性

**核心特性：**

- 无服务器架构
- 零配置
- 单个磁盘文件
- 跨平台支持
- 事务支持

**数据类型：**

- NULL
- INTEGER
- REAL
- TEXT
- BLOB

### 2.2 SQLite配置

**数据库初始化：**

```sql
-- 启用外键约束
PRAGMA foreign_keys = ON;

-- 设置WAL模式以提高并发性能
PRAGMA journal_mode = WAL;

-- 设置同步模式为NORMAL
PRAGMA synchronous = NORMAL;

-- 设置缓存大小为10MB
PRAGMA cache_size = -10000;
```

**性能优化：**

```sql
-- 分析表统计信息
ANALYZE;

-- 优化数据库
VACUUM;
```

## 3. sqlite3 库

### 3.1 sqlite3特性使用

**基本使用：**

```javascript
const sqlite3 = require('sqlite3').verbose();

// 创建数据库连接
const db = new sqlite3.Database('./data/automate.db', (err) => {
  if (err) {
    console.error('Error opening database:', err.message);
  } else {
    console.log('Connected to the SQLite database.');
  }
});

// 执行SQL语句
db.run('CREATE TABLE IF NOT EXISTS chat_messages (id INTEGER PRIMARY KEY AUTOINCREMENT, agent_id TEXT NOT NULL, content TEXT NOT NULL, message_type TEXT NOT NULL, send_time DATETIME DEFAULT CURRENT_TIMESTAMP)', (err) => {
  if (err) {
    console.error('Error creating table:', err.message);
  }
});

// 插入数据
db.run('INSERT INTO chat_messages (agent_id, content, message_type) VALUES (?, ?, ?)', ['agent1', 'Hello', 'user'], function(err) {
  if (err) {
    console.error('Error inserting data:', err.message);
  } else {
    console.log(`A row has been inserted with rowid ${this.lastID}`);
  }
});

// 查询数据
db.all('SELECT * FROM chat_messages WHERE agent_id = ?', ['agent1'], (err, rows) => {
  if (err) {
    console.error('Error querying data:', err.message);
  } else {
    rows.forEach(row => {
      console.log(row);
    });
  }
});

// 关闭数据库连接
db.close((err) => {
  if (err) {
    console.error('Error closing database:', err.message);
  } else {
    console.log('Database connection closed.');
  }
});
```

**使用Promise包装：**

```javascript
const sqlite3 = require('sqlite3').verbose();

class Database {
  constructor(dbPath) {
    this.db = new sqlite3.Database(dbPath);
    this.init();
  }

  init() {
    // 创建表
    this.run(`
      CREATE TABLE IF NOT EXISTS chat_messages (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        agent_id TEXT NOT NULL,
        agent_name TEXT NOT NULL,
        user_id TEXT NOT NULL,
        user_name TEXT NOT NULL,
        content TEXT NOT NULL,
        message_type TEXT NOT NULL,
        send_time DATETIME DEFAULT CURRENT_TIMESTAMP,
        status TEXT DEFAULT 'sent',
        message_length INTEGER DEFAULT 0,
        has_attachment BOOLEAN DEFAULT false,
        attachment_path TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );
    `);
  }

  run(sql, params = []) {
    return new Promise((resolve, reject) => {
      this.db.run(sql, params, function(err) {
        if (err) {
          reject(err);
        } else {
          resolve({ id: this.lastID });
        }
      });
    });
  }

  get(sql, params = []) {
    return new Promise((resolve, reject) => {
      this.db.get(sql, params, (err, result) => {
        if (err) {
          reject(err);
        } else {
          resolve(result);
        }
      });
    });
  }

  all(sql, params = []) {
    return new Promise((resolve, reject) => {
      this.db.all(sql, params, (err, rows) => {
        if (err) {
          reject(err);
        } else {
          resolve(rows);
        }
      });
    });
  }

  close() {
    return new Promise((resolve, reject) => {
      this.db.close((err) => {
        if (err) {
          reject(err);
        } else {
          resolve();
        }
      });
    });
  }
}

module.exports = Database;
```

### 3.2 sqlite3最佳实践

- 使用Promise包装回调API，简化异步操作
- 使用参数化查询防止SQL注入
- 使用事务确保数据一致性
- 合理使用索引优化查询性能
- 定期执行VACUUM和ANALYZE命令
- 关闭不再使用的数据库连接

## 4. better-sqlite3

### 4.1 better-sqlite3特性使用

**基本使用：**

```javascript
const Database = require('better-sqlite3');

// 创建数据库连接
const db = new Database('./data/automate.db');

// 执行SQL语句
db.exec(`
  CREATE TABLE IF NOT EXISTS chat_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id TEXT NOT NULL,
    content TEXT NOT NULL,
    message_type TEXT NOT NULL,
    send_time DATETIME DEFAULT CURRENT_TIMESTAMP
  );
`);

// 插入数据
const insert = db.prepare('INSERT INTO chat_messages (agent_id, content, message_type) VALUES (?, ?, ?)');
const result = insert.run('agent1', 'Hello', 'user');
console.log(`A row has been inserted with rowid ${result.lastInsertRowid}`);

// 查询单条数据
const get = db.prepare('SELECT * FROM chat_messages WHERE id = ?');
const row = get.get(1);
console.log(row);

// 查询多条数据
const getAll = db.prepare('SELECT * FROM chat_messages WHERE agent_id = ?');
const rows = getAll.all('agent1');
rows.forEach(row => {
  console.log(row);
});

// 关闭数据库连接
db.close();
```

**使用事务：**

```javascript
const Database = require('better-sqlite3');
const db = new Database('./data/automate.db');

// 开始事务
db.transaction(() => {
  // 执行多个操作
  const insert1 = db.prepare('INSERT INTO chat_messages (agent_id, content, message_type) VALUES (?, ?, ?)');
  insert1.run('agent1', 'Hello', 'user');
  
  const insert2 = db.prepare('INSERT INTO chat_messages (agent_id, content, message_type) VALUES (?, ?, ?)');
  insert2.run('agent1', 'How are you?', 'user');
  
  // 如果有错误，事务会自动回滚
})();

db.close();
```

### 4.2 better-sqlite3最佳实践

- 使用预编译语句提高性能
- 使用事务处理多个相关操作
- 使用索引优化查询性能
- 合理设置缓存大小
- 定期执行VACUUM和ANALYZE命令
- 关闭不再使用的数据库连接

## 5. 数据库操作

### 5.1 基本操作

**创建表：**

```javascript
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./data/automate.db');

db.run(`
  CREATE TABLE IF NOT EXISTS agents (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    avatar TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
`);

db.run(`
  CREATE TABLE IF NOT EXISTS chat_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id TEXT NOT NULL,
    content TEXT NOT NULL,
    message_type TEXT NOT NULL,
    send_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status TEXT DEFAULT 'sent',
    FOREIGN KEY (agent_id) REFERENCES agents (id)
  );
`);

db.close();
```

**插入数据：**

```javascript
const Database = require('./database'); // 自定义数据库类
const db = new Database('./data/automate.db');

async function insertAgent() {
  try {
    await db.run(
      'INSERT INTO agents (id, name, description) VALUES (?, ?, ?)',
      ['agent1', 'Assistant', 'A helpful assistant']
    );
    console.log('Agent inserted successfully');
  } catch (error) {
    console.error('Error inserting agent:', error);
  } finally {
    await db.close();
  }
}

insertAgent();
```

**查询数据：**

```javascript
const Database = require('./database');
const db = new Database('./data/automate.db');

async function getAgents() {
  try {
    const agents = await db.all('SELECT * FROM agents WHERE is_active = ?', [true]);
    console.log('Active agents:', agents);
  } catch (error) {
    console.error('Error getting agents:', error);
  } finally {
    await db.close();
  }
}

getAgents();
```

**更新数据：**

```javascript
const Database = require('./database');
const db = new Database('./data/automate.db');

async function updateAgent() {
  try {
    await db.run(
      'UPDATE agents SET name = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?',
      ['Updated Assistant', 'agent1']
    );
    console.log('Agent updated successfully');
  } catch (error) {
    console.error('Error updating agent:', error);
  } finally {
    await db.close();
  }
}

updateAgent();
```

**删除数据：**

```javascript
const Database = require('./database');
const db = new Database('./data/automate.db');

async function deleteAgent() {
  try {
    await db.run('DELETE FROM agents WHERE id = ?', ['agent1']);
    console.log('Agent deleted successfully');
  } catch (error) {
    console.error('Error deleting agent:', error);
  } finally {
    await db.close();
  }
}

deleteAgent();
```

## 6. 数据库性能优化

### 6.1 索引优化

**创建索引：**

```javascript
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./data/automate.db');

// 智能体ID索引
db.run('CREATE INDEX IF NOT EXISTS idx_chat_messages_agent_id ON chat_messages(agent_id)');

// 发送时间索引
db.run('CREATE INDEX IF NOT EXISTS idx_chat_messages_send_time ON chat_messages(send_time)');

// 复合索引
db.run('CREATE INDEX IF NOT EXISTS idx_chat_messages_agent_send_time ON chat_messages(agent_id, send_time)');

db.close();
```

**索引分析：**

```javascript
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./data/automate.db');

// 查看索引使用情况
db.all('EXPLAIN QUERY PLAN SELECT * FROM chat_messages WHERE agent_id = ?', ['agent1'], (err, rows) => {
  if (err) {
    console.error('Error analyzing query plan:', err);
  } else {
    rows.forEach(row => {
      console.log(row);
    });
  }
});

db.close();
```

### 6.2 查询优化

**使用索引：**

```javascript
// 优化前（全表扫描）
db.all('SELECT * FROM chat_messages WHERE agent_id = ? ORDER BY send_time DESC LIMIT 100', ['agent1'], (err, rows) => {
  // 处理结果
});

// 优化后（使用索引）
db.all('SELECT * FROM chat_messages WHERE agent_id = ? ORDER BY send_time DESC LIMIT 100', ['agent1'], (err, rows) => {
  // 处理结果
});
```

**使用LIMIT限制结果数量：**

```javascript
// 限制返回结果数量
db.all('SELECT * FROM chat_messages WHERE agent_id = ? ORDER BY send_time DESC LIMIT 100', ['agent1'], (err, rows) => {
  // 处理结果
});
```

### 6.3 数据库维护

**定期执行VACUUM：**

```javascript
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./data/automate.db');

db.run('VACUUM', (err) => {
  if (err) {
    console.error('Error running VACUUM:', err);
  } else {
    console.log('VACUUM completed successfully');
  }
});

db.close();
```

**定期执行ANALYZE：**

```javascript
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('./data/automate.db');

db.run('ANALYZE', (err) => {
  if (err) {
    console.error('Error running ANALYZE:', err);
  } else {
    console.log('ANALYZE completed successfully');
  }
});

db.close();
```

**数据库备份：**

```javascript
const fs = require('fs').promises;

async function backupDatabase(source, destination) {
  try {
    await fs.copyFile(source, destination);
    console.log('Database backup completed successfully');
  } catch (error) {
    console.error('Error backing up database:', error);
    throw error;
  }
}

// 使用示例
backupDatabase('./data/automate.db', './backup/automate.db.backup');
```

## 7. 数据库安全

### 7.1 数据加密

**使用SQLCipher加密数据库：**

```javascript
// 注意：需要安装sqlite3的加密扩展或使用sqlcipher
const sqlite3 = require('sqlite3').verbose();

// 打开加密数据库（示例）
const db = new sqlite3.Database('./data/automate.db');
db.run('PRAGMA key = "secret-key";', (err) => {
  if (err) {
    console.error('Error setting encryption key:', err);
  } else {
    console.log('Encryption key set successfully');
  }
});

db.close();
```

### 7.2 访问控制

**设置数据库文件权限：**

```javascript
const fs = require('fs');

function setDatabasePermissions(dbPath) {
  try {
    // 在Windows上，文件权限设置有所不同
    // 这里仅作为示例
    if (process.platform === 'win32') {
      console.log('Setting file permissions is not necessary on Windows');
    } else {
      // 在Unix-like系统上设置权限
      fs.chmodSync(dbPath, 0o600);
      console.log('Database file permissions set successfully');
    }
  } catch (error) {
    console.error('Error setting database permissions:', error);
  }
}

// 使用示例
setDatabasePermissions('./data/automate.db');
```

## 8. 参考资源

- [SQLite官方文档](https://www.sqlite.org/docs.html)
- [sqlite3 npm包文档](https://www.npmjs.com/package/sqlite3)
- [better-sqlite3 npm包文档](https://www.npmjs.com/package/better-sqlite3)
- [Node.js官方文档](https://nodejs.org/docs/latest-v18.x/api/)
- [SQLite性能优化指南](https://sqlite.org/optoverview.html)