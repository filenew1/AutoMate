# 架构设计

本文档定义了AutoMate项目的整体架构设计。

## 1. 架构概述

### 1.1 架构类型

AutoMate采用**前后端分离架构**，使用Tauri框架构建跨平台桌面应用。

### 1.2 架构特点

- **前后端分离**：前端使用React + TypeScript，后端使用Node.js
- **跨平台支持**：使用Tauri框架支持Windows、macOS、Linux
- **轻量级设计**：使用SQLite作为数据库，无需额外安装数据库服务器
- **模块化架构**：按功能模块划分代码，便于维护和扩展
- **本地化存储**：所有数据存储在本地，不上传云端

## 2. 整体架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                     用户界面层                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ 智能体模块   │  │ 聊天交互模块  │  │ 主题模块     │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
│  ┌─────────────┐  ┌─────────────┐                │
│  │ 启动页模块   │  │ 通用组件     │                │
│  └─────────────┘  └─────────────┘                │
└─────────────────────────────────────────────────────────┘
                        ↓ Tauri invoke API
┌─────────────────────────────────────────────────────────┐
│                     业务逻辑层                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ 智能体服务   │  │ 聊天服务     │  │ 技能服务     │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
│  ┌─────────────┐  ┌─────────────┐                │
│  │ 文件服务     │  │ 配置服务     │                │
│  └─────────────┘  └─────────────┘                │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     数据访问层                        │
│  ┌─────────────┐  ┌─────────────┐                │
│  │ 数据库模型   │  │ 文件存储     │                │
│  └─────────────┘  └─────────────┘                │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     数据存储层                        │
│  ┌─────────────┐  ┌─────────────┐                │
│  │ SQLite数据库  │  │ 本地文件系统  │                │
│  └─────────────┘  └─────────────┘                │
└─────────────────────────────────────────────────────────┘
```

### 2.2 架构说明

**用户界面层：**

- 负责用户交互和界面展示
- 使用React + TypeScript构建
- 通过Tauri invoke API调用后端服务

**业务逻辑层：**

- 负责业务逻辑处理
- 使用Node.js构建
- 提供API接口供前端调用

**数据访问层：**

- 负责数据访问和存储
- 使用Node.js兼容的SQLite库（如sqlite3或better-sqlite3）
- 提供数据模型和访问接口

**数据存储层：**

- 负责数据持久化存储
- 使用SQLite数据库
- 使用本地文件系统存储文件

## 3. 模块划分

### 3.1 前端模块

**模块列表：**

- 智能体模块：负责智能体的加载、分组、搜索、状态管理
- 聊天交互模块：负责消息发送与接收、技能调用、文件上传
- 主题模块：负责主题切换、样式适配
- 启动页模块：负责应用启动流程、欢迎页展示

**模块依赖关系：**

```
启动页模块
    ↓
智能体模块
    ↓
聊天交互模块
    ↓
主题模块
```

### 3.2 后端模块

**模块列表：**

- 智能体服务：负责智能体配置加载和管理
- 聊天服务：负责消息发送和接收
- 技能服务：负责技能调用和执行
- 文件服务：负责文件上传和下载
- 配置服务：负责配置文件管理

**模块依赖关系：**

```
配置服务
    ↓
智能体服务
    ↓
聊天服务
    ↓
技能服务
    ↓
文件服务
```

## 4. 技术选型

### 4.1 前端技术选型

| 技术 | 选型理由 |
| :--- | :--- |
| React | 提供类型安全的组件化开发，适合构建复杂的用户界面 |
| TypeScript | 提供类型安全，定义完整的接口类型和联合类型 |
| Tailwind CSS | 快速构建响应式UI，减少CSS代码量 |
| Vite | 快速的开发和构建体验，适合现代前端项目 |
| React Router | 实现单页应用路由管理 |
| React Query | 管理服务器状态和数据缓存，优化数据获取和更新 |

### 4.2 后端技术选型

| 技术 | 选型理由 |
| :--- | :--- |
| Node.js | 基于Chrome V8引擎的JavaScript运行时，性能优异，生态丰富，适合构建高效的后端服务。作为前端技术的自然延伸，使用JavaScript/TypeScript可以实现前后端代码复用，降低开发成本 |
| Playwright | 功能强大的浏览器自动化工具，支持多种浏览器，提供丰富的API用于网页操作、截图、网络请求拦截等，适合智能体的网页交互需求 |

### 4.3 数据库技术选型

| 技术 | 选型理由 |
| :--- | :--- |
| SQLite | 轻量级嵌入式数据库，无需额外安装，适合桌面应用 |
| sqlite3 或 better-sqlite3 | Node.js兼容的SQLite库，提供同步和异步API，简化数据库操作 |

### 4.4 构建工具选型

| 技术 | 选型理由 |
| :--- | :--- |
| Tauri | 轻量级桌面应用框架，支持跨平台，使用Web技术构建UI |
| Vite | 快速的开发和构建体验，支持热更新 |
| pkg | 将Node.js应用打包为独立可执行文件 |

## 5. 数据流设计

### 5.1 消息发送流程

```
用户输入消息
    ↓
前端验证输入
    ↓
前端调用后端API（Tauri invoke）
    ↓
后端验证消息
    ↓
后端保存消息到数据库
    ↓
后端调用智能体API
    ↓
智能体处理消息
    ↓
智能体返回回复
    ↓
后端保存回复到数据库
    ↓
后端推送回复到前端（Tauri事件）
    ↓
前端显示回复
```

### 5.2 技能调用流程

```
智能体需要调用技能
    ↓
后端解析技能调用请求
    ↓
后端验证技能参数
    ↓
后端保存技能调用记录到数据库
    ↓
后端执行技能（直接使用Node.js）
    ↓
技能执行完成
    ↓
后端更新技能调用记录
    ↓
后端推送执行结果到前端（Tauri事件）
    ↓
前端显示执行结果
```

### 5.3 文件上传流程

```
用户选择文件
    ↓
前端验证文件类型和大小
    ↓
前端调用后端API（Tauri invoke）
    ↓
后端接收文件
    ↓
后端保存文件到本地存储
    ↓
后端计算文件哈希值
    ↓
后端保存文件元数据到数据库
    ↓
后端返回文件信息到前端
    ↓
前端显示文件预览
```

## 6. 通信机制

### 6.1 前后端通信

**invoke API：**

- 前端通过Tauri invoke API调用后端函数
- 同步调用，等待后端返回结果

**事件系统：**

- 后端通过Tauri事件系统向前端推送消息
- 异步推送，前端监听事件

### 6.2 前端组件通信

**Props传递：**

- 父组件通过Props向子组件传递数据

**Context API：**

- 使用Context API实现跨组件状态共享

**自定义Hooks：**

- 使用自定义Hooks封装可复用逻辑

### 6.3 后端服务通信

**服务调用：**

- 服务之间通过函数调用进行通信

**数据库访问：**

- 服务通过ORM框架访问数据库

## 7. 部署架构

### 7.1 本地部署

**部署方式：**

- 使用Tauri构建桌面应用
- 打包为独立可执行文件
- 用户下载安装后直接运行

**部署步骤：**

1. 使用Tauri构建应用
2. 打包为独立可执行文件
3. 发布到应用商店或官网下载

### 7.2 更新机制

**更新流程：**

1. 应用启动时检查更新
2. 如果有新版本，提示用户更新
3. 用户确认后下载更新包
4. 安装更新并重启应用

## 8. 安全架构

### 8.1 数据安全

- 聊天数据本地加密存储（AES-256）
- 智能体配置文件权限控制
- 技能执行沙箱隔离
- 敏感信息加密存储

### 8.2 接口安全

- 使用参数化查询防止SQL注入
- 所有用户输入进行验证和清理
- 使用textContent而不是innerHTML
- 技能执行使用进程隔离

## 9. 性能架构

### 9.1 前端性能

- 使用虚拟滚动优化长列表
- 使用React.memo避免不必要的重新渲染
- 使用代码分割减少初始加载时间
- 使用缓存减少重复计算

### 9.2 后端性能

- 使用异步IO提高并发性能
- 使用索引优化数据库查询
- 使用连接池管理数据库连接
- 使用缓存减少重复计算

## 10. 可扩展性架构

### 10.1 模块扩展

- 支持添加新的功能模块
- 模块间通过接口通信
- 模块可独立开发和测试

### 10.2 技能扩展

- 支持添加新的技能类型
- 技能通过插件系统加载
- 技能可独立开发和测试

### 10.3 消息类型扩展

- 支持添加新的消息类型
- 消息处理器可注册和扩展
- 消息类型可自定义

## 11. 开发环境配置

### 11.1 开发服务器配置

**服务器启动位置**：必须在项目根目录启动开发服务器

**项目根目录**：`f:\AI软件\AutoMate`

**正确的启动方式**：
```bash
cd "f:\AI软件\AutoMate"
python -m http.server 8080
```

**注意事项**：
- Python http.server 默认不允许访问上级目录（安全限制）
- 在子目录启动会导致无法访问 `config/` 目录
- 会导致配置文件加载失败（404错误）

### 11.2 资源路径规范

**HTML中的资源路径**：
- 使用绝对路径：`/config/agents.json`
- 不使用相对路径：`../config/agents.json`

**原因**：
- 服务器在根目录启动时，绝对路径更可靠
- 避免因文件位置变化导致的路径错误
- 与生产环境路径保持一致

### 11.3 访问地址

**开发服务器地址**：`http://localhost:8080`

**原型页面地址**：`http://localhost:8080/prototypes/MainLayout.html`

**配置文件地址**：`http://localhost:8080/config/agents.json`

### 11.4 常见问题排查

**配置文件加载失败**：
1. 检查服务器启动位置是否在项目根目录
2. 检查文件路径是否使用绝对路径
3. 检查浏览器Console错误信息
4. 检查Network标签中的请求状态

**样式加载失败**：
1. 检查CSS文件路径
2. 检查文件是否存在
3. 清除浏览器缓存
4. 检查Network标签中的请求状态

**JavaScript错误**：
1. 查看Console错误信息
2. 检查语法错误
3. 检查变量未定义错误
4. 检查异步操作错误

## 12. 参考资源

- [Tauri官方文档](https://tauri.app/)
- [React官方文档](https://react.dev/)
- [Node.js官方文档](https://nodejs.org/docs/latest-v18.x/api/)
- [Playwright官方文档](https://playwright.dev/docs/intro)
- [SQLite官方文档](https://www.sqlite.org/docs.html)
- [开发环境配置规范](../基础规范/开发环境配置.md)
