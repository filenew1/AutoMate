# 数据库事务最佳实践

本文档定义了AutoMate项目中数据库事务使用的最佳实践,确保数据一致性和系统性能。

## 1. 事务基本原则

### 1.1 保持事务尽可能短
- 事务执行时间应尽可能短,避免长时间持有锁
- 建议单个事务执行时间不超过100ms
- 避免在事务中进行复杂计算或网络请求

### 1.2 避免在事务中进行长时间操作
- 不要在事务中进行文件I/O操作
- 不要在事务中进行网络请求
- 不要在事务中进行复杂的业务逻辑计算
- 长时间操作应在事务外完成

### 1.3 使用try-except-finally确保事务正确提交或回滚
- 所有数据库操作必须使用try-catch包裹
- 成功时必须调用commit()
- 失败时必须调用rollback()
- 确保资源正确释放

### 1.4 在事务中避免用户交互
- 事务执行期间不应等待用户输入
- 避免在事务中显示UI提示
- 用户交互应在事务开始前或结束后进行

## 2. 事务使用场景

### 2.1 消息发送事务
- 插入消息记录
- 更新消息状态
- 删除相关技能调用记录

### 2.2 技能调用事务
- 插入技能调用记录
- 更新技能调用状态
- 记录执行结果

### 2.3 文件上传事务
- 插入文件附件记录
- 更新消息关联
- 记录文件元数据

## 3. 事务错误处理

### 3.1 错误类型
- 数据库连接错误
- SQL语法错误
- 约束违反错误
- 并发冲突错误

### 3.2 错误处理策略
- 记录详细错误信息
- 回滚所有未提交的更改
- 向用户显示友好的错误消息
- 确保系统状态一致性

## 4. 事务性能优化

### 4.1 减少锁争用
- 按合理顺序访问表
- 避免长时间持有锁
- 使用适当的隔离级别

### 4.2 批量操作
- 使用批量插入代替单条插入
- 减少事务次数
- 提高整体性能

## 5. 事务测试

### 5.1 单元测试
- 测试正常流程
- 测试异常流程
- 测试回滚机制

### 5.2 集成测试
- 测试并发事务
- 测试事务嵌套
- 测试性能表现