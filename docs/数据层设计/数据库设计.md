# 数据库设计

本文档定义了AutoMate项目的数据库设计，包括表结构、索引、事务等。

## 1. 数据库概述

### 1.1 数据库类型

- **数据库类型**：SQLite 3.40.0+
- **数据库文件路径**：`./data/automate.db`
- **数据库驱动**：sqlite3 或 better-sqlite3（Node.js兼容的SQLite库）

### 1.2 数据库特性

- 轻量级嵌入式数据库，无需额外安装
- 支持事务处理
- 支持外键约束
- 支持索引优化
- 支持数据加密

### 1.3 数据库初始化

**初始化脚本：**

```sql
-- 启用外键约束
PRAGMA foreign_keys = ON;

-- 设置WAL模式以提高并发性能
PRAGMA journal_mode = WAL;

-- 设置同步模式为NORMAL
PRAGMA synchronous = NORMAL;

-- 设置缓存大小为10MB
PRAGMA cache_size = -10000;
```

## 2. 表结构设计

### 2.1 聊天消息表 (chat_messages)

**表描述：**

存储用户和智能体之间的聊天消息。

**表结构：**

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INTEGER` | `PRIMARY KEY AUTOINCREMENT` | 消息ID，主键，自增 |
| `agent_id` | `VARCHAR(255)` | `NOT NULL` | 智能体ID |
| `agent_name` | `VARCHAR(255)` | `NOT NULL` | 智能体名称 |
| `user_id` | `VARCHAR(255)` | `NOT NULL` | 用户ID |
| `user_name` | `VARCHAR(255)` | `NOT NULL` | 用户名称 |
| `content` | `TEXT` | `NOT NULL` | 消息内容 |
| `message_type` | `VARCHAR(50)` | `NOT NULL` | 消息类型（user/agent） |
| `send_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 发送时间 |
| `status` | `VARCHAR(50)` | `DEFAULT 'sent'` | 消息状态（sent/delivered/read/failed） |
| `message_length` | `INTEGER` | `DEFAULT 0` | 消息长度 |
| `has_attachment` | `BOOLEAN` | `DEFAULT FALSE` | 是否包含附件 |
| `attachment_path` | `TEXT` | | 附件路径 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

**字段说明：**

- `id`: 主键，自增，唯一标识每条消息
- `agent_id`: 关联的智能体ID，用于查询特定智能体的消息
- `agent_name`: 智能体名称，冗余字段，便于查询和显示
- `user_id`: 用户ID，用于标识消息发送者
- `user_name`: 用户名称，冗余字段，便于查询和显示
- `content`: 消息内容，使用TEXT类型支持长文本
- `message_type`: 消息类型，user表示用户发送的消息，agent表示智能体回复的消息
- `send_time`: 消息发送时间，用于排序和查询
- `status`: 消息状态，sent（已发送）、delivered（已送达）、read（已读）、failed（失败）
- `message_length`: 消息长度，用于统计和优化
- `has_attachment`: 是否包含附件，布尔值
- `attachment_path`: 附件路径，如果消息包含附件
- `created_at`: 记录创建时间
- `updated_at`: 记录更新时间

**创建语句：**

```sql
CREATE TABLE IF NOT EXISTS chat_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id VARCHAR(255) NOT NULL,
    agent_name VARCHAR(255) NOT NULL,
    user_id VARCHAR(255) NOT NULL,
    user_name VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    message_type VARCHAR(50) NOT NULL,
    send_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'sent',
    message_length INTEGER DEFAULT 0,
    has_attachment BOOLEAN DEFAULT FALSE,
    attachment_path TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 技能调用表 (skill_calls)

**表描述：**

存储智能体调用技能的记录。

**表结构：**

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INTEGER` | `PRIMARY KEY AUTOINCREMENT` | 调用ID，主键，自增 |
| `message_id` | `INTEGER` | `REFERENCES chat_messages(id)` | 消息ID，外键 |
| `agent_id` | `VARCHAR(255)` | `NOT NULL` | 智能体ID |
| `skill_name` | `VARCHAR(255)` | `NOT NULL` | 技能名称 |
| `parameters` | `TEXT` | | 技能参数，JSON格式 |
| `call_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 调用时间 |
| `status` | `VARCHAR(50)` | `DEFAULT 'pending'` | 执行状态（pending/success/failed/timeout） |
| `result` | `TEXT` | | 执行结果 |
| `execution_time` | `INTEGER` | `DEFAULT 0` | 执行时间（毫秒） |
| `error_message` | `TEXT` | | 错误信息 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

**字段说明：**

- `id`: 主键，自增，唯一标识每次技能调用
- `message_id`: 关联的消息ID，外键，关联到chat_messages表
- `agent_id`: 调用技能的智能体ID
- `skill_name`: 调用的技能名称
- `parameters`: 技能参数，JSON格式存储
- `call_time`: 技能调用时间
- `status`: 执行状态，pending（待执行）、success（成功）、failed（失败）、timeout（超时）
- `result`: 执行结果，JSON格式存储
- `execution_time`: 执行时间，单位毫秒
- `error_message`: 错误信息，如果执行失败
- `created_at`: 记录创建时间
- `updated_at`: 记录更新时间

**创建语句：**

```sql
CREATE TABLE IF NOT EXISTS skill_calls (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_id INTEGER REFERENCES chat_messages(id) ON DELETE CASCADE ON UPDATE CASCADE,
    agent_id VARCHAR(255) NOT NULL,
    skill_name VARCHAR(255) NOT NULL,
    parameters TEXT,
    call_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'pending',
    result TEXT,
    execution_time INTEGER DEFAULT 0,
    error_message TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2.3 智能体状态表 (agent_states)

**表描述：**

存储智能体的在线状态和响应时间等信息。

**表结构：**

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INTEGER` | `PRIMARY KEY AUTOINCREMENT` | 状态ID，主键，自增 |
| `agent_id` | `VARCHAR(255)` | `UNIQUE NOT NULL` | 智能体ID，唯一 |
| `agent_name` | `VARCHAR(255)` | `NOT NULL` | 智能体名称 |
| `online_status` | `BOOLEAN` | `DEFAULT FALSE` | 在线状态 |
| `last_online_time` | `DATETIME` | | 最后在线时间 |
| `response_time` | `INTEGER` | `DEFAULT 0` | 响应时间（毫秒） |
| `status_message` | `TEXT` | | 状态消息 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

**字段说明：**

- `id`: 主键，自增
- `agent_id`: 智能体ID，唯一标识
- `agent_name`: 智能体名称
- `online_status`: 在线状态，TRUE表示在线，FALSE表示离线
- `last_online_time`: 最后在线时间
- `response_time`: 响应时间，单位毫秒
- `status_message`: 状态消息，描述智能体的当前状态
- `created_at`: 记录创建时间
- `updated_at`: 记录更新时间

**创建语句：**

```sql
CREATE TABLE IF NOT EXISTS agent_states (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id VARCHAR(255) UNIQUE NOT NULL,
    agent_name VARCHAR(255) NOT NULL,
    online_status BOOLEAN DEFAULT FALSE,
    last_online_time DATETIME,
    response_time INTEGER DEFAULT 0,
    status_message TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2.4 文件附件表 (file_attachments)

**表描述：**

存储消息的文件附件信息。

**表结构：**

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `INTEGER` | `PRIMARY KEY AUTOINCREMENT` | 文件ID，主键，自增 |
| `message_id` | `INTEGER` | `REFERENCES chat_messages(id) ON DELETE CASCADE` | 关联的消息ID，外键 |
| `file_name` | `VARCHAR(255)` | `NOT NULL` | 文件名 |
| `file_type` | `VARCHAR(100)` | `NOT NULL` | 文件类型 |
| `file_size` | `INTEGER` | `NOT NULL` | 文件大小（字节） |
| `storage_path` | `TEXT` | `NOT NULL` | 存储路径 |
| `file_hash` | `VARCHAR(255)` | | 文件哈希值 |
| `upload_time` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 上传时间 |
| `created_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

**字段说明：**

- `id`: 主键，自增
- `message_id`: 关联的消息ID，外键，关联到chat_messages表
- `file_name`: 文件名
- `file_type`: 文件类型（MIME类型）
- `file_size`: 文件大小，单位字节
- `storage_path`: 文件存储路径
- `file_hash`: 文件哈希值，用于去重和校验
- `upload_time`: 文件上传时间
- `created_at`: 记录创建时间
- `updated_at`: 记录更新时间

**创建语句：**

```sql
CREATE TABLE IF NOT EXISTS file_attachments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_id INTEGER REFERENCES chat_messages(id) ON DELETE CASCADE ON UPDATE CASCADE,
    file_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(100) NOT NULL,
    file_size INTEGER NOT NULL,
    storage_path TEXT NOT NULL,
    file_hash VARCHAR(255),
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 索引设计

### 3.1 聊天消息表索引

**索引列表：**

```sql
-- 智能体ID索引
CREATE INDEX IF NOT EXISTS idx_chat_messages_agent_id ON chat_messages(agent_id);

-- 发送时间索引
CREATE INDEX IF NOT EXISTS idx_chat_messages_send_time ON chat_messages(send_time);

-- 智能体ID和发送时间复合索引
CREATE INDEX IF NOT EXISTS idx_chat_messages_agent_send_time ON chat_messages(agent_id, send_time);

-- 用户ID索引
CREATE INDEX IF NOT EXISTS idx_chat_messages_user_id ON chat_messages(user_id);

-- 消息类型索引
CREATE INDEX IF NOT EXISTS idx_chat_messages_message_type ON chat_messages(message_type);

-- 消息状态索引
CREATE INDEX IF NOT EXISTS idx_chat_messages_status ON chat_messages(status);
```

**索引说明：**

- `idx_chat_messages_agent_id`: 优化按智能体ID查询消息的性能
- `idx_chat_messages_send_time`: 优化按时间排序查询的性能
- `idx_chat_messages_agent_send_time`: 优化按智能体和时间范围查询的性能
- `idx_chat_messages_user_id`: 优化按用户ID查询消息的性能
- `idx_chat_messages_message_type`: 优化按消息类型查询的性能
- `idx_chat_messages_status`: 优化按消息状态查询的性能

### 3.2 技能调用表索引

**索引列表：**

```sql
-- 消息ID索引
CREATE INDEX IF NOT EXISTS idx_skill_calls_message_id ON skill_calls(message_id);

-- 调用时间索引
CREATE INDEX IF NOT EXISTS idx_skill_calls_call_time ON skill_calls(call_time);

-- 消息ID和调用时间复合索引
CREATE INDEX IF NOT EXISTS idx_skill_calls_message_call_time ON skill_calls(message_id, call_time);

-- 智能体ID索引
CREATE INDEX IF NOT EXISTS idx_skill_calls_agent_id ON skill_calls(agent_id);

-- 技能名称索引
CREATE INDEX IF NOT EXISTS idx_skill_calls_skill_name ON skill_calls(skill_name);

-- 执行状态索引
CREATE INDEX IF NOT EXISTS idx_skill_calls_status ON skill_calls(status);
```

**索引说明：**

- `idx_skill_calls_message_id`: 优化按消息ID查询技能调用的性能
- `idx_skill_calls_call_time`: 优化按时间查询技能调用的性能
- `idx_skill_calls_message_call_time`: 优化按消息和时间查询技能调用的性能
- `idx_skill_calls_agent_id`: 优化按智能体ID查询技能调用的性能
- `idx_skill_calls_skill_name`: 优化按技能名称查询技能调用的性能
- `idx_skill_calls_status`: 优化按执行状态查询技能调用的性能

### 3.3 智能体状态表索引

**索引列表：**

```sql
-- 智能体ID索引（主键索引）
CREATE INDEX IF NOT EXISTS idx_agent_states_agent_id ON agent_states(agent_id);

-- 在线状态索引
CREATE INDEX IF NOT EXISTS idx_agent_states_online_status ON agent_states(online_status);

-- 最后在线时间索引
CREATE INDEX IF NOT EXISTS idx_agent_states_last_online_time ON agent_states(last_online_time);
```

**索引说明：**

- `idx_agent_states_agent_id`: 优化按智能体ID查询状态的性能
- `idx_agent_states_online_status`: 优化按在线状态查询智能体的性能
- `idx_agent_states_last_online_time`: 优化按最后在线时间查询智能体的性能

### 3.4 文件附件表索引

**索引列表：**

```sql
-- 消息ID索引
CREATE INDEX IF NOT EXISTS idx_file_attachments_message_id ON file_attachments(message_id);

-- 文件哈希索引
CREATE INDEX IF NOT EXISTS idx_file_attachments_file_hash ON file_attachments(file_hash);

-- 上传时间索引
CREATE INDEX IF NOT EXISTS idx_file_attachments_upload_time ON file_attachments(upload_time);
```

**索引说明：**

- `idx_file_attachments_message_id`: 优化按消息ID查询附件的性能
- `idx_file_attachments_file_hash`: 优化按文件哈希查询附件的性能（用于去重）
- `idx_file_attachments_upload_time`: 优化按上传时间查询附件的性能

## 4. 事务设计

### 4.1 事务隔离级别

- **默认隔离级别**：SERIALIZABLE
- **设置方式**：`PRAGMA read_uncommitted = false;`

### 4.2 事务使用场景

**消息发送事务：**

```javascript
const Database = require('better-sqlite3');
const path = require('path');

function sendMessage(content, agentId) {
    const db = new Database(path.join(__dirname, '../../data/automate.db'));
    db.pragma('journal_mode = WAL');
    
    const transaction = db.transaction(() => {
        const stmt = db.prepare(
            'INSERT INTO chat_messages (content, agent_id, message_type) VALUES (?, ?, ?)'
        );
        const result = stmt.run(content, agentId, 'user');
        return result.lastInsertRowid;
    });
    
    try {
        const messageId = transaction();
        return getMessage(messageId);
    } catch (error) {
        throw error;
    } finally {
        db.close();
    }
}
```

**技能调用事务：**

```javascript
function callSkill(messageId, skillName, parameters) {
    const db = new Database(path.join(__dirname, '../../data/automate.db'));
    db.pragma('journal_mode = WAL');
    
    const transaction = db.transaction(() => {
        const stmt = db.prepare(
            'INSERT INTO skill_calls (message_id, skill_name, parameters, status) VALUES (?, ?, ?, ?)'
        );
        const result = stmt.run(messageId, skillName, JSON.stringify(parameters), 'pending');
        return result.lastInsertRowid;
    });
    
    try {
        const callId = transaction();
        return getSkillCall(callId);
    } catch (error) {
        throw error;
    } finally {
        db.close();
    }
}

### 4.3 事务最佳实践

- 保持事务尽可能短
- 避免在事务中进行长时间操作
- 使用try-except-finally确保事务正确提交或回滚
- 在事务中避免用户交互

## 5. 数据库优化

### 5.1 查询优化

**使用索引：**

- 为常用查询字段创建索引
- 避免在索引列上使用函数
- 使用复合索引优化多条件查询

**查询优化示例：**

```sql
-- 优化前（全表扫描）
SELECT * FROM chat_messages WHERE agent_id = 'agent1' ORDER BY send_time DESC LIMIT 100;

-- 优化后（使用索引）
SELECT * FROM chat_messages
WHERE agent_id = 'agent1'
ORDER BY send_time DESC
LIMIT 100;
```

### 5.2 数据库维护

**定期执行VACUUM：**

```sql
VACUUM;
```

**定期执行ANALYZE：**

```sql
ANALYZE;
```

**数据库备份：**

```javascript
const fs = require('fs');
const path = require('path');

function backupDatabase(source, destination) {
    fs.copyFileSync(source, destination);
}
```

### 5.3 性能监控

**查询性能分析：**

```sql
-- 启用查询计划
EXPLAIN QUERY PLAN SELECT * FROM chat_messages WHERE agent_id = 'agent1';
```

**数据库大小监控：**

```javascript
const fs = require('fs');

function getDatabaseSize(dbPath) {
    const stats = fs.statSync(dbPath);
    return stats.size;
}
```

## 6. 数据库迁移

### 6.1 使用better-sqlite3

**迁移管理：**

better-sqlite3提供了简单直接的数据库迁移方式，通过执行SQL语句来修改数据库结构。

**迁移脚本示例：**

```javascript
const Database = require('better-sqlite3');
const path = require('path');

function migrateDatabase(dbPath) {
    const db = new Database(dbPath);
    db.pragma('journal_mode = WAL');
    
    try {
        // 创建迁移版本表
        db.exec(`
            CREATE TABLE IF NOT EXISTS schema_migrations (
                version INTEGER PRIMARY KEY,
                applied_at DATETIME DEFAULT CURRENT_TIMESTAMP
            );
        `);
        
        // 检查当前版本
        const currentVersion = db.prepare('SELECT MAX(version) as version FROM schema_migrations').get();
        const version = currentVersion ? currentVersion.version : 0;
        
        // 执行迁移
        if (version < 1) {
            // 迁移1：添加新列到chat_messages表
            db.exec(`
                ALTER TABLE chat_messages ADD COLUMN new_column VARCHAR(255);
            `);
            db.prepare('INSERT INTO schema_migrations (version) VALUES (1)').run();
        }
        
        console.log('Migration completed successfully');
    } catch (error) {
        console.error('Migration failed:', error);
        throw error;
    } finally {
        db.close();
    }
}
```

## 7. 数据库安全

### 7.1 数据加密

**使用SQLCipher加密数据库：**

```javascript
const Database = require('better-sqlite3');
const path = require('path');

function connectEncryptedDatabase(dbPath, key) {
    const db = new Database(dbPath);
    db.pragma(`key = '${key}'`);
    return db;
}
```

### 7.2 访问控制

**设置数据库文件权限：**

```javascript
const fs = require('fs');

function setDatabasePermissions(dbPath) {
    fs.chmodSync(dbPath, 0o600);
}
```

## 8. 参考资源

- [SQLite官方文档](https://www.sqlite.org/docs.html)
- [better-sqlite3文档](https://github.com/WiseLibs/better-sqlite3)
- [sqlite3文档](https://github.com/TryGhost/node-sqlite3)
- [Node.js官方文档](https://nodejs.org/docs/)
