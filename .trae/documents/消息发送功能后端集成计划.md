# 消息发送功能后端集成计划

## 需求概述
当用户在前端界面输入消息内容后，点击发送按钮，调用Node.js后端处理用户请求，并将结果返回前端展示。

## 现状分析

### 前端 (ChatContainer.tsx)
- 目前使用模拟响应：`这是智能体的回复：${inputText}`
- 需要改为调用后端API

### 后端
- `backend/services/` 目录存在但文件为空
- 需要创建agentService.ts实现后端逻辑
- 技能定义在 `skills/` 目录

### 配置
- 智能体配置在 `config/agents.json`
- 每个智能体有 `url`, `api_key`, `model`, `skills` 配置

---

## 实现步骤

### 步骤1：创建后端Agent服务

**文件**: `backend/services/agentService.ts`

实现功能：
1. `createAgent(skillPaths, apiKey, model)` - 创建带技能的智能体
2. `chat(agentId, userMessage)` - 使用智能体进行对话
3. 加载智能体配置
4. 调用LLM API
5. 集成技能系统

核心逻辑：
- 读取 `config/agents.json` 获取智能体配置
- 根据agentId查找对应智能体
- 构建包含技能上下文的prompt
- 调用LLM API (OpenAI兼容格式)
- 返回响应内容

### 步骤2：创建Tauri命令处理程序

**文件**: `src-tauri/src/commands.rs` (如不存在则新建)

实现Tauri命令：
- `chat_with_agent(agent_id: String, message: String) -> ChatResponse`
- 错误处理和日志记录

### 步骤3：更新前端聊天组件

**文件**: `src/components/chat/ChatContainer.tsx`

修改 `handleSend` 函数：
1. 获取用户输入的消息
2. 调用Tauri的invoke API发送消息到后端
3. 处理响应并更新UI
4. 显示加载状态
5. 错误处理

### 步骤4：类型定义

**文件**: `src/types/chat.ts` (新建)

定义类型：
```typescript
interface ChatResponse {
  content: string
  skill_used?: string
  agent_id: string
}
```

### 步骤5：测试验证

1. 运行开发服务器
2. 发送测试消息
3. 验证后端调用成功
4. 验证响应正确显示

---

## 技术细节

### API调用格式
使用OpenAI兼容格式：
```typescript
POST {agent_url}/chat/completions
Headers: {
  "Authorization": "Bearer {api_key}",
  "Content-Type": "application/json"
}
Body: {
  "model": "{model}",
  "messages": [
    { "role": "system", "content": "{skill_context}" },
    { "role": "user", "content": "{user_message}" }
  ]
}
```

### 技能集成
- 读取 `skills/{skill_name}/SKILL.md` 获取技能定义
- 将技能描述加入system prompt

---

## 错误处理
- API调用失败：返回错误信息到前端
- 智能体未找到：返回404错误
- 网络超时：设置30秒超时
- 技能加载失败：跳过技能，使用默认提示词

---

## 预计修改文件
1. `backend/services/agentService.ts` (新建)
2. `src/components/chat/ChatContainer.tsx` (修改)
3. `src/types/chat.ts` (新建)
4. `src-tauri/src/commands.rs` (新建，如需要Tauri后端)
